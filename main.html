<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>For Us</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Inter&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Inter;background:#0e0e0e;color:#f2f2f2;overflow-x:hidden}
.entry{position:relative;min-height:100dvh;width:100%;padding:4rem 1rem;display:flex;justify-content:center}
.bg{position:fixed;top:0;left:0;width:100vw;height:100dvh;background-repeat:no-repeat;background-size:cover;background-position:center;filter:blur(var(--bg-blur,4px)) brightness(var(--bg-bright,0.9));transform:scale(1.05);z-index:-10}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:-1}
.content{position:relative;width:100%;max-width:640px;z-index:2}
.controls{display:flex;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
button,label{background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff;font-size:.65rem;padding:.35rem .6rem}
label{display:flex;flex-direction:column;font-size:.6rem}
#journalText{font-family:Playfair Display;font-size:1.2rem;line-height:1.8;margin-bottom:2rem;outline:none}
.block{position:relative;margin-bottom:1.5rem;touch-action:none}
.memory{width:160px;aspect-ratio:1/1;overflow:hidden;cursor:pointer}
.memory.square{border-radius:14px}
.memory.circle{border-radius:50%}
.memory.rect16_9{aspect-ratio:16/9;border-radius:14px}
.memory.rect4_5{aspect-ratio:4/5;border-radius:14px}
.memory img{width:100%;height:100%;object-fit:cover;filter:blur(12px)}
.caption{margin-top:.4rem;font-family:Playfair Display;opacity:.85}
.textBlock{font-family:Playfair Display;padding:.6rem .8rem;background:rgba(255,255,255,.05);border-radius:8px;min-width:120px;min-height:40px;outline:none}
.resize-handle{position:absolute;width:12px;height:12px;background:#fff;z-index:10;display:none}
.unlocked .resize-handle{display:block}
.resize-nw{top:-6px;left:-6px;cursor:nwse-resize}
.resize-ne{top:-6px;right:-6px;cursor:nesw-resize}
.resize-sw{bottom:-6px;left:-6px;cursor:nesw-resize}
.resize-se{bottom:-6px;right:-6px;cursor:nwse-resize}
.delete{position:absolute;top:-8px;right:-8px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.7);display:none;justify-content:center;align-items:center;cursor:pointer;z-index:20}
.unlocked .delete{display:flex}
.separator{width:100%;height:1px;background:linear-gradient(to right,transparent,rgba(255,255,255,.5),transparent);position:relative}
.separator::after{content:'✦';position:absolute;left:50%;top:-10px;transform:translateX(-50%);padding:0 .4rem}
#memoryModal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:100;padding:1rem;box-sizing:border-box}
.modal-content{display:flex;flex-direction:column;gap:1rem;align-items:center;max-width:100%;max-height:100%}
.modal-caption{font-family:'Playfair Display';text-align:center;color:#fff;padding:0 1rem}
.exporting{background:#fff;color:#000}
.exporting .controls,.exporting .delete,.exporting .resize-handle{display:none!important}
@media(max-width:600px){.entry{padding:2rem 1rem}.content{max-width:100%}.memory{width:42vw}}
@media(max-width:768px){body{overflow-x:hidden}.entry{padding:3rem 1rem}.bg{background-position:center}}
#particles{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:-5;pointer-events:none}
</style>
</head>

<body>

<section class="entry">
  <canvas id="particles"></canvas>
  <div class="bg"></div>
  <div class="overlay"></div>
  <div class="content">
    <div class="controls">
      <button id="lockBtn">unlock</button>
      <button id="addMemory">memory</button>
      <button id="addText">text</button>
      <button id="addSeparator">section</button>
      <button id="changeBG">bg</button>
      <button id="exportPDF">pdf</button>
      <button onclick="toggleBGMode()">fit / fill</button>
      <button id="exportHTML">export html</button>
      <label>blur<input id="bgBlur" type="range" min="0" max="12" step="0.5"></label>
      <label>bright<input id="bgBright" type="range" min="0.6" max="1.2" step="0.05"></label>
    </div>
    <div id="journalText" contenteditable="false">
           For gee <3
    </div>
    <div id="blocks"></div>
  </div>
</section>

<div id="memoryModal">
  <div class="modal-content">
    <img>
    <div class="modal-caption"></div>
  </div>
</div>

<script>
/* ---------- STATE ---------- */
let locked=true;
let blocks=JSON.parse(localStorage.getItem('blocks')||'[]');
const blocksEl=document.getElementById('blocks');
const bg=document.querySelector('.bg');

bg.style.backgroundImage=`url(${localStorage.getItem('bg')||''})`;

let bgMode = localStorage.getItem('bgMode') || 'cover';
bg.style.backgroundSize = bgMode;

const blur=document.getElementById('bgBlur');
const bright=document.getElementById('bgBright');

blur.value=localStorage.getItem('bgBlur')||4;
bright.value=localStorage.getItem('bgBright')||.95;

bg.style.setProperty('--bg-blur',blur.value+'px');
bg.style.setProperty('--bg-bright',bright.value);

let bgBrightness=parseFloat(bright.value)||0.95;

blur.oninput=e=>{bg.style.setProperty('--bg-blur',e.target.value+'px');localStorage.setItem('bgBlur',e.target.value);}
bright.oninput=e=>{bgBrightness=parseFloat(e.target.value);bg.style.setProperty('--bg-bright',e.target.value);localStorage.setItem('bgBright',e.target.value);}

function toggleBGMode() {
  bgMode = (bgMode === 'cover') ? 'contain' : 'cover';
  bg.style.backgroundSize = bgMode;
  localStorage.setItem('bgMode', bgMode);
}

/* ---------- HELPERS ---------- */
function save(){localStorage.setItem('blocks',JSON.stringify(blocks));}
function makeDraggable(el,data){
  let sx,sy;
  el.style.transform=`translate(${data.x||0}px,${data.y||0}px)`;
  el.onpointerdown=e=>{
    if(locked||e.target.closest('.delete')||e.target.closest('.resize-handle')) return;
    sx=e.clientX-(data.x||0); sy=e.clientY-(data.y||0); el.setPointerCapture(e.pointerId);
  };
  el.onpointermove=e=>{if(!el.hasPointerCapture(e.pointerId)) return; data.x=e.clientX-sx; data.y=e.clientY-sy; el.style.transform=`translate(${data.x}px,${data.y}px)`;};
  el.onpointerup=()=>save();
}
function makeResizable(block,data){
  ['nw','ne','sw','se'].forEach(p=>{
    const h=document.createElement('div'); h.className=`resize-handle resize-${p}`; block.appendChild(h);
    let sx,sy,sw,sh;
    h.onpointerdown=e=>{if(locked) return; e.stopPropagation(); sx=e.clientX; sy=e.clientY; sw=block.offsetWidth; sh=block.offsetHeight; h.setPointerCapture(e.pointerId);};
    h.onpointermove=e=>{if(!h.hasPointerCapture(e.pointerId)) return; const dx=e.clientX-sx, dy=e.clientY-sy; block.style.width=Math.max(120,sw+(p.includes('e')?dx:-dx))+'px'; block.style.height=Math.max(40,sh+(p.includes('s')?dy:-dy))+'px';};
    h.onpointerup=()=>{data.w=block.offsetWidth; data.h=block.offsetHeight; save();};
  });
}

/* ---------- RENDER ---------- */
function render(){
  blocksEl.innerHTML='';
  blocks.forEach(b=>{if(b.type==='text') createText(b); if(b.type==='memory') createMemory(b); if(b.type==='separator') createSeparator(b);});
}

/* ---------- CREATE ---------- */
function createText(d){
  const b=document.createElement('div'); b.className='block'; makeDraggable(b,d); makeResizable(b,d);
  if(d.w) b.style.width=d.w+'px'; if(d.h) b.style.height=d.h+'px';
  const t=document.createElement('div'); t.className='textBlock'; t.contentEditable=!locked; t.innerText=d.text||''; t.oninput=()=>{d.text=t.innerText; save();}
  const del=document.createElement('div'); del.className='delete'; del.innerText='×'; del.onpointerdown=e=>e.stopPropagation(); del.onclick=e=>{ e.stopPropagation(); if(!locked){blocks=blocks.filter(x=>x.id!==d.id); save(); render();} };
  b.append(del,t); blocksEl.appendChild(b);
}

function createMemory(d){
  const b=document.createElement('div'); b.className='block'; makeDraggable(b,d);
  const m=document.createElement('div'); m.className='memory '+(d.shape||'square');
  const img=document.createElement('img'); img.src=d.image; m.appendChild(img);
  const cap=document.createElement('div'); cap.className='caption'; cap.contentEditable=!locked; cap.innerText=d.text||''; cap.oninput=()=>{ d.text=cap.innerText; save(); };
  const del=document.createElement('div'); del.className='delete'; del.innerText='×'; del.onpointerdown=e=>e.stopPropagation(); del.onclick=e=>{ e.stopPropagation(); if(!locked){ blocks=blocks.filter(x=>x.id!==d.id); save(); render(); } };
  m.onclick=()=>{ const modal=document.getElementById('memoryModal'); modal.style.display='flex'; modal.querySelector('img').src=d.image; modal.querySelector('.modal-caption').innerText=d.text||''; };
  b.append(del,m,cap); blocksEl.appendChild(b);
}

function createSeparator(d){ const b=document.createElement('div'); b.className='block'; makeDraggable(b,d); const s=document.createElement('div'); s.className='separator'; const del=document.createElement('div'); del.className='delete'; del.innerText='×'; del.onpointerdown=e=>e.stopPropagation(); del.onclick=e=>{ e.stopPropagation(); if(!locked){blocks=blocks.filter(x=>x.id!==d.id); save(); render();} }; b.append(del,s); blocksEl.appendChild(b);}

/* ---------- CONTROLS ---------- */
lockBtn.onclick=()=>{ locked=!locked; document.body.classList.toggle('unlocked',!locked); lockBtn.innerText=locked?'unlock':'lock'; render(); };
addText.onclick=()=>{ if(locked) return; blocks.push({id:Date.now(),type:'text'}); save(); render(); };
addMemory.onclick=()=>{
  if(locked) return;
  const shape=prompt('1=16:9 2=Square 3=4:5 4=Circle','2');
  const map={1:'rect16_9',2:'square',3:'rect4_5',4:'circle'};
  const i=document.createElement('input'); i.type='file'; i.accept='image/*';
  i.onchange=e=>{ const r=new FileReader(); r.onload=()=>{ blocks.push({id:Date.now(),type:'memory',image:r.result,shape:map[shape]}); save(); render(); }; r.readAsDataURL(e.target.files[0]); };
  i.click();
};
addSeparator.onclick=()=>{ if(locked) return; blocks.push({id:Date.now(),type:'separator'}); save(); render(); };
changeBG.onclick=()=>{ const i=document.createElement('input'); i.type='file'; i.accept='image/*'; i.onchange=e=>{ const r=new FileReader(); r.onload=()=>{ localStorage.setItem('bg',r.result); bg.style.backgroundImage=`url(${r.result})`; }; r.readAsDataURL(e.target.files[0]); }; i.click(); };
exportPDF.onclick=()=>{ document.body.classList.add('exporting'); html2pdf().from(document.body).save().then(()=>{ document.body.classList.remove('exporting'); }); };

document.getElementById('memoryModal').onclick = (e) => {
  if (e.target === document.getElementById('memoryModal')) {
    e.currentTarget.style.display = 'none';
  }
};

document.getElementById('exportHTML').onclick = () => {
  const clone = document.documentElement.cloneNode(true);

  clone.querySelectorAll('.controls, .delete, .resize-handle').forEach(el => el.remove());
  clone.querySelectorAll('[contenteditable]').forEach(el => el.removeAttribute('contenteditable'));

  const cloneBg = clone.querySelector('.bg');
  if (cloneBg) cloneBg.style.backgroundImage = 'none';

  const style = document.createElement('style');
  style.innerHTML = `
    .memory { cursor: pointer; touch-action: manipulation; }
    .memory img { filter: none !important; }
    #memoryModal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,.9); 
      justify-content: center; 
      align-items: center; 
      z-index: 100; 
      padding: 1rem;
      box-sizing: border-box;
    }
    #memoryModal .modal-content { 
      display: flex; 
      flex-direction: column; 
      gap: 1.5rem; 
      align-items: center; 
      max-width: 100%;
      max-height: 100%;
    }
    #memoryModal img { 
      max-width: 100%; 
      max-height: 80vh; 
      object-fit: contain; 
    }
    #memoryModal .modal-caption { 
      font-family: 'Playfair Display', serif; 
      text-align: center; 
      color: #fff; 
      padding: 0 1rem; 
      max-width: 100%;
      font-size: 1.2rem;
    }
    @media (max-width: 600px) {
      #memoryModal { 
        padding: 0; 
        background: #000; 
      }
      #memoryModal img { 
        max-height: 75vh; 
      }
      #memoryModal .modal-caption { 
        font-size: 1.1rem; 
        padding: 1rem;
      }
    }
    #particles { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -5; pointer-events: none; }
  `;
  clone.querySelector('head').appendChild(style);

  const script = document.createElement('script');
  script.textContent = `
    document.querySelectorAll('.memory').forEach(m => {
      m.onclick = () => {
        const modal = document.getElementById('memoryModal');
        const fullImg = m.querySelector('img').src;
        const caption = m.parentElement.querySelector('.caption')?.innerText || '';
        modal.querySelector('img').src = fullImg;
        modal.querySelector('.modal-caption').innerText = caption;
        modal.style.display = 'flex';
      };
    });

    const modal = document.getElementById('memoryModal');
    modal.onclick = (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    };

    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    let w, h;
    function resize(){ w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
    resize(); window.addEventListener('resize', resize);

    const pointer = {x:null, y:null};
    window.addEventListener('mousemove', e => { pointer.x = e.clientX; pointer.y = e.clientY; });
    window.addEventListener('touchmove', e => { pointer.x = e.touches[0].clientX; pointer.y = e.touches[0].clientY; });
    window.addEventListener('mouseleave', () => { pointer.x = pointer.y = null; });

    const COUNT = Math.min(120, Math.floor((w * h) / 9000));
    const particles = [];
    for (let i = 0; i < COUNT; i++) {
      particles.push({
        x: Math.random() * w,
        y: Math.random() * h,
        r: Math.random() * 1.4 + 0.6,
        vx: (Math.random() - 0.5) * 0.25,
        vy: (Math.random() - 0.5) * 0.25,
        baseAlpha: Math.random() * 0.4 + 0.2
      });
    }

    const bgBrightness = ${bgBrightness};

    function animate() {
      ctx.clearRect(0, 0, w, h);
      const glow = bgBrightness < 0.7;
      particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        if (p.x < 0) p.x = w;
        if (p.x > w) p.x = 0;
        if (p.y < 0) p.y = h;
        if (p.y > h) p.y = 0;

        let alpha = p.baseAlpha;
        if (pointer.x !== null) {
          const dx = p.x - pointer.x;
          const dy = p.y - pointer.y;
          const d = Math.hypot(dx, dy);
          if (d < 120) {
            const f = (120 - d) / 120;
            p.vx += (dx / d) * f * 0.02;
            p.vy += (dy / d) * f * 0.02;
            alpha += f * 0.4;
            alpha = Math.min(alpha, 1);
          }
        }

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
        if (glow) { ctx.shadowBlur = 12; ctx.shadowColor = 'rgba(255,240,200,0.8)'; }
        else { ctx.shadowBlur = 0; }
        ctx.fillStyle = \`rgba(255,245,230,\${alpha})\`;
        ctx.fill();
      });
      ctx.shadowBlur = 0;
      requestAnimationFrame(animate);
    }
    animate();
  `;
  const cloneBody = clone.querySelector('body');
  if (cloneBody) cloneBody.appendChild(script);

  const html = '<!DOCTYPE html>\\n' + clone.outerHTML;
  const blob = new Blob([html], {type: 'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'memory.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
};

render();

/* ---------- PARTICLES (editor) ---------- */
const canvas=document.getElementById('particles');
const ctx=canvas.getContext('2d');
let w,h;
function resizeCanvas(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
resizeCanvas(); window.addEventListener('resize',resizeCanvas);
const pointer={x:null,y:null};
window.addEventListener('mousemove',e=>{pointer.x=e.clientX;pointer.y=e.clientY;});
window.addEventListener('touchmove',e=>{pointer.x=e.touches[0].clientX;pointer.y=e.touches[0].clientY;});
window.addEventListener('mouseleave',()=>{pointer.x=pointer.y=null;});
const COUNT=Math.min(120,Math.floor((w*h)/9000));
const particles=[];
for(let i=0;i<COUNT;i++){particles.push({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.4+0.6,vx:(Math.random()-0.5)*0.25,vy:(Math.random()-0.5)*0.25,baseAlpha:Math.random()*0.4+0.2});}
function animate(){
  ctx.clearRect(0,0,w,h);
  const glow=bgBrightness<0.7;
  particles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0)p.x=w; if(p.x>w)p.x=0; if(p.y<0)p.y=h; if(p.y>h)p.y=0;
    let alpha=p.baseAlpha;
    if(pointer.x!==null){ 
      const dx=p.x-pointer.x; const dy=p.y-pointer.y; const d=Math.hypot(dx,dy); 
      if(d<120){ const f=(120-d)/120; p.vx+=(dx/d)*f*0.02; p.vy+=(dy/d)*f*0.02; alpha+=f*0.4; alpha=Math.min(alpha,1); } 
    }
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    if(glow){ ctx.shadowBlur=12; ctx.shadowColor='rgba(255,240,200,0.8)'; } else { ctx.shadowBlur=0; }
    ctx.fillStyle=`rgba(255,245,230,${alpha})`; ctx.fill();
  });
  ctx.shadowBlur=0; requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
